<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Video</title>
<style>
:root { --w: 1600px; --gap: 18px; }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#fafafa; color:#111; }
.wrap { max-width: var(--w); margin: 40px auto; padding: 0 16px; margin-left: 260px;}
.card { background:#fff; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding:28px; }
h1,h2 { margin:0 0 12px; }
.btnrow { display:flex; gap:12px; margin-top:22px; }
button { border:0; padding:12px 16px; border-radius:10px; cursor:pointer; background:#1f6feb; color:#fff; font-weight:600; }
button.secondary { background:#e9eef7; color:#163a76; }
button:disabled { background:#ccc; color:#666; cursor:not-allowed; }
.hidden { display:none; }
.quiz-item { margin:14px 0 18px; padding:14px; border-radius:12px; background:#f8fafc; }
.vid { width:100%; max-width:var(--w); aspect-ratio:16/9; background:#000; border-radius:12px; }
.input { display: block; width:100%; max-width: 100%; box-sizing: border-box; padding:12px 14px; border-radius:10px; border:1px solid #d0d7de; font-size:16px; }
.muted { color:#555; font-size:14px; }
.hr { height:1px; background:#eee; margin:16px 0; }
.list { margin:0; padding-left:1.2rem; }
#log-container {
position: fixed;
bottom: 10px;
right: 10px;
width: 400px;
max-height: 200px;
overflow-y: auto;
background: rgba(255, 255, 255, 0.9);
padding: 10px;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.2);
font-size: 12px;
z-index: 1000;
}
#alt-video-prompt-container {
  padding: 16px;
  background: #f0f6ff;
  border-radius: 12px;
  margin-top: 20px;
  border: 1px solid #b9d2ff;
}
#alt-video-prompt-container p {
  margin: 0 0 10px;
  font-weight: 500;
  color: #163a76;
}
/* Sidebar for video navigation */
#video-sidebar {
  position: fixed;
  top: 60px;
  left: 10px;
  width: 220px;
  background: #fff;
  border: 1px solid #d0d7de;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
  padding: 12px;
  font-size: 15px;
  z-index: 900;
}
#video-sidebar h3 {
  margin: 0 0 10px;
  font-size: 16px;
  color: #163a76;
}
#video-sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
#video-sidebar li {
  margin: 6px 0;
}
#video-sidebar button {
  background: none;
  border: none;
  color: #1f6feb;
  font-weight: 600;
  text-align: left;
  cursor: pointer;
  padding: 4px 0;
}
#video-sidebar button:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<div class="wrap">

<div id="screen-intro" class="card">
<h1>Welcome to the course!</h1>
<p>There are videos here for you to watch. Check it out.</p>
<ul class="list">
<li>Rule: Please complete all answers on your own. AI tools are not allowed.</li>
<li>Here is the video that covers XYZ topic.</li>
</ul>
<div class="btnrow">
  <button id="fullscreen-btn">Enter Fullscreen to Continue</button>
</div>
<p class="muted">⚠️ <strong>You must stay in fullscreen during the session. Exiting fullscreen will end the study immediately</strong>. Please also be aware that navigating away from this window will end the session.
Each student has only <span style="font-weight:700; color:#b91c1c;">one attempt</span>.</p>
</div>
<div id="screen-id" class="card hidden">
<h2>Please input your Andrew ID</h2>
<input id="participant-id" class="input" placeholder="paste your Andrew ID" />
<div class="btnrow">
<button class="secondary" id="back-1">← Back</button>
<button id="to-pre">→ Continue</button>
</div>
</div>
<div id="screen-verifying" class="card hidden">
  <h2>Verifying your Andrew ID…</h2>
  <p class="muted">Please wait a moment while we check your eligibility. This can take up to 10 seconds.</p>
  <div style="background:#eee;border-radius:8px;overflow:hidden;margin-top:16px;">
    <div id="verify-progress" style="height:14px;width:0;background:#1f6feb;transition:width 0.3s ease;"></div>
  </div>
</div>
<div id="screen-blocked" class="card hidden">
  <h2>Access denied</h2>
  <p class="muted">⚠️ You have already completed this activity. Only one attempt is allowed.</p>
</div>
<div id="screen-pre" class="card hidden">
<h2>Pre-quiz</h2>
<p class="muted">Answer a few questions before the video.</p>
<div id="pre-quiz"></div>
<div class="btnrow">
<button id="to-video">→ Continue to video</button>
</div>
</div>

<div id="screen-video-1" class="card hidden">
    <h2>Video Part 1: Introduction</h2>
    <p class="muted">You can fast-forward/rewind. We record interactions (play, pause, jumps).</p>
    <div id="video-container-1"></div>
    <div id="prompt-container-1"></div>
    <div class="btnrow">
        <button id="to-video-2">→ Continue to Part 2</button>
    </div>
</div>

<div id="screen-video-2" class="card hidden">
    <h2>Video Part 2: Why Matters?</h2>
    <p class="muted">You can fast-forward/rewind. We record interactions (play, pause, jumps).</p>
    <div id="video-container-2"></div>
    <div id="prompt-container-2"></div>
    <div class="btnrow">
        <button id="to-video-3">→ Continue to Part 3</button>
    </div>
</div>

<div id="screen-video-3" class="card hidden">
    <h2>Video Part 3: Core Concepts</h2>
    <p class="muted">You can fast-forward/rewind. We record interactions (play, pause, jumps).</p>
    <div id="video-container-3"></div>
    <div id="prompt-container-3"></div>
    <div class="btnrow">
        <button id="to-video-4">→ Continue to Part 4</button>
    </div>
</div>

<div id="screen-video-4" class="card hidden">
    <h2>Video Part 4: Conclusion</h2>
    <p class="muted">You can fast-forward/rewind. We record interactions (play, pause, jumps).</p>
    <div id="video-container-4"></div>
    <div id="prompt-container-4"></div>
    <div class="btnrow">
        <button id="to-post">→ Continue to post-quiz</button>
    </div>
</div>
<div id="video-sidebar" class="hidden">
  <h3>Video Parts</h3>
  <ul id="sidebar-list"></ul>
</div>

<div id="screen-post" class="card hidden">
<h2>Post-quiz</h2>
<p class="muted">Questions to test yourself. Answers and interaction logs are recorded.</p>
<div id="post-quiz"></div>
<div class="btnrow">
<button id="to-survey">→ Continue to Survey</button>
</div>
</div>

<div id="screen-survey" class="card hidden">
<h2>Survey</h2>
<p class="muted">Please answer these final questions about your experience.</p>
<div id="survey-quiz"></div>
<div class="btnrow">
<button id="to-finish">→ Finish</button>
</div>
</div>

<div id="screen-done" class="card hidden">
<h2>Thank you!</h2>
<p>Your response has been recorded.</p>
</div>
</div>
<div id="log-container" class="hidden">
    <h3>Event Log</h3>
    <div id="event-log"></div>
    <div style="height:1px; background:#ddd; margin: 8px 0;"></div>
    <strong>Watched Intervals:</strong>
    <div id="intervals-display" style="font-family: monospace; padding-top: 4px;">
        [No intervals recorded yet]
    </div>
</div>

<video id="lecture" class="vid" controls controlsList="nodownload nofullscreen" preload="metadata" style="display:none;"></video>

<script>

/*** === CONFIG === ***/
const LOGGER_URL = 'https://script.google.com/macros/s/AKfycbxNZH8ojntqLhX-KPN8DDatSGFVE_C4w_ELAvAeAzxBvcrlN09CB-I8vub_JWCjGCcKEw/exec'; // (replay + attempt)
const MAX_VIDEO_MINUTES = 20;

/*** === STATE & UTIL === ***/
const sessionId = crypto.randomUUID();
let participantId = '';
let treatmentGroup = -1;
let page = 'intro';
let sessionStartTime = Date.now();
let eventCounter = 0;
let eventQueue = [];
let batchTimer = null;
let isAltVideo = false;
let isExitingForPrompt = false;
// --- MODIFIED ---
// New flag to prevent the prompt from showing immediately after returning from an alt video.
let isReturningFromAlt = false;

const BATCH_INTERVAL = 3000;
const MAX_QUEUE_SIZE = 20;

function fmt(t) { return Number(t || 0).toFixed(2); }

function addToLog(message) {
const logContainer = document.getElementById('event-log');
const logEntry = document.createElement('div');
logEntry.textContent = message;
logContainer.appendChild(logEntry);
logContainer.scrollTop = logContainer.scrollHeight;
}

const parts = [
  { partNumber: 1, topic: "Introduction",
    mainSrc: "https://www.dropbox.com/scl/fi/350ea5iypwa99mbmd3yim/When-Conditions-Change-So-Does-the-Rate.mp4?rlkey=he9wvbdy2087nujkbrwtg7iey&st=a1uocf1l&raw=1",
    altSrc: "https://www.dropbox.com/scl/fi/pc3ws56rqc0mglit2uvkg/RCII-U5-S2.mp4?rlkey=22axv1dg8getivo9ke3zizxsx&st=5q52eoqv&raw=1"
  },
  { partNumber: 2, topic: "Why Matters?",
    mainSrc: "https://www.dropbox.com/scl/fi/7320pzlpkjs0vvp17wefs/Strong-Acids-and-Bases-All-In_-Acid_Base-Edition.mp4?rlkey=45twyqmmb99yvve23s14r2w77&st=6t2cz6vk&raw=1",
    altSrc: "https://www.dropbox.com/scl/fi/qxefp6rba6w664vdyvsga/RCII-U7-S1.mp4?rlkey=7vldsfpdlja0e7vqoazwjfzy1&raw=1"
  },
  { partNumber: 3, topic: "Core Concepts",
    mainSrc: "https://www.dropbox.com/scl/fi/vekzd50iegquo1yquphwd/Curve-Your-Enthusiasm-for-Kinetics.mp4?rlkey=67shz1rirk2ankpen9mar1kbx&st=b8wwztxd&raw=1",
    altSrc: "https://www.dropbox.com/scl/fi/62h7npfuualeoi0kia1vz/RCII-U4-S3.mp4?rlkey=rfavu6e58l5kt2lnu6pfgik4v&st=yhzk8z3c&raw=1"
  },
  { partNumber: 4, topic: "Conclusion",
    mainSrc: "https://www.dropbox.com/scl/fi/qzxv6ngpl3oyfy9e1xijy/Burning-Rusting-and-Everything-Between.mp4?rlkey=cfc6nbnl11ir3ni7nxebcj51p&st=6bizmjwb&raw=1",
    altSrc: "https://www.dropbox.com/scl/fi/1jryc87it4jvwmpbzxptp/RCII-U1-S3.mp4?rlkey=70dmcyj8ng5xp65nfj8i3xyc9&st=8e1zb6od&raw=1"
  },
];

const sidebarList = document.getElementById('sidebar-list');
parts.forEach(part => {
  const li = document.createElement('li');
  const btn = document.createElement('button');
  btn.textContent = `Part ${part.partNumber}: ${part.topic}`;
  btn.addEventListener('click', () => {
    logEvent('sidebar-click', { part: part.partNumber, topic: part.topic });
    show(`screen-video-${part.partNumber}`);
    enterPage(`video-${part.partNumber}`);
    setupVideoLogging();
  });
  li.appendChild(btn);
  sidebarList.appendChild(li);
});

function getCurrentPart() {
    if (!currentScreenId.startsWith('screen-video-')) return null;
    const partNumber = parseInt(currentScreenId.split('-')[2], 10);
    return parts.find(p => p.partNumber === partNumber);
}

function sendBatch(isUnloading = false) {
  if (eventQueue.length === 0) return;

  const batchToSend = [...eventQueue];
  eventQueue = [];
  const data = JSON.stringify(batchToSend);

  if (isUnloading) {
    navigator.sendBeacon?.(LOGGER_URL, new Blob([data], { type: 'text/plain' }));
  } else {
    fetch(LOGGER_URL, {
    method: 'POST',
    headers: {'Content-Type':'text/plain'},
    body: data,
    keepalive: true
    }).catch(err => {
    console.error('Failed to send event batch:', err);
    eventQueue.unshift(...batchToSend);
    });
  }
}

function logEvent(event, payload = {}, videoTime = null) {
    eventCounter++;
    const sessionTime = (Date.now() - sessionStartTime) / 1000;
    const eventData = {
    sessionId, participantId, page, event, videoTime,
    payload, sessionTime, timestamp: Date.now(), sequence: eventCounter
};

const displaySessionTime = fmt(sessionTime);
let logMessage = `[${String(eventCounter).padStart(4, '0')}] At ${displaySessionTime} ${event}`;
if (videoTime !== null) logMessage += ` at ${fmt(videoTime)}`;
if (Object.keys(payload).length > 0) logMessage += ` (${JSON.stringify(payload)})`;
addToLog(logMessage);

eventQueue.push(eventData);

if (eventQueue.length >= MAX_QUEUE_SIZE) {
clearTimeout(batchTimer);
sendBatch();
return;
}
clearTimeout(batchTimer);
batchTimer = setTimeout(sendBatch, BATCH_INTERVAL);
}

let currentScreenId = 'screen-intro';
const video = document.getElementById('lecture');

function show(id) {
  const existingPrompt = document.getElementById('alt-video-prompt-container');
  if (existingPrompt) existingPrompt.remove();

  const isSwitchingToVideoPage = id.startsWith('screen-video-');
  const isLeavingVideoPage = currentScreenId.startsWith('screen-video-') && !isSwitchingToVideoPage;

  if (isLeavingVideoPage) {
    pauseVideoIfPlaying('nav-away');
    video.style.display = 'none';
    document.body.appendChild(video);
  }

  document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  currentScreenId = id;

  const sidebar = document.getElementById('video-sidebar');
  if (isSwitchingToVideoPage) {
    sidebar.classList.remove('hidden');
  } else {
    sidebar.classList.add('hidden');
  }

  if (isSwitchingToVideoPage) {
    isAltVideo = false;
    watchedIntervals = [];
    updateIntervalsDisplay();
    hasEverPlayed = false;
    currentWatchStart = null;
    lastVideoTime = 0;

    const partNumber = parseInt(id.split('-')[2], 10);
    const container = document.getElementById(`video-container-${partNumber}`);
    const part = parts.find(p => p.partNumber === partNumber);
    
    if (container && part) {
      container.appendChild(video);
      video.style.display = 'block';

      if (video.src !== part.mainSrc) {
        video.src = part.mainSrc;
        video.load();
      }
    }
  }
}

function ts() { return new Date().toISOString().replace('T',' ').slice(0,19); }

function getSessionTime() {
return Number(((Date.now() - sessionStartTime) / 1000).toFixed(2));
}

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        if (!['screen-intro', 'screen-id', 'screen-verifying', 'screen-blocked', 'screen-done'].includes(currentScreenId)) {
            logEvent('visibility-hidden-forced-exit');
            pauseVideoIfPlaying('tab-hidden');
            logEvent('post-quiz-complete', { forced: true, reason: 'visibility-hidden' });
            show('screen-done');
            enterPage('finish');
            clearTimeout(batchTimer);
            sendBatch();
        }
    }
});

window.addEventListener('beforeunload', () => {
if (currentScreenId.startsWith('screen-video-')) {
pauseVideoIfPlaying('unload');
}
sendBatch(true);
});

/*** === QUIZZES === ***/
const preQuestions = [
{ no: 1, text: 'Pre Q1', options: ['A','B','C','D'] }, { no: 2, text: 'Pre Q2', options: ['A','B','C','D'] }, { no: 3, text: 'Pre Q3', options: ['A','B','C','D'] }, { no: 4, text: 'Pre Q4', options: ['A','B','C','D'] }, { no: 5, text: 'Pre Q5', options: ['A','B','C','D'] },
];

const postQuestions = [
{ no: 6, text: 'Post Q1', options: ['A','B','C','D'] }, { no: 7, text: 'Post Q2', options: ['A','B','C','D'] }, { no: 8, text: 'Post Q3', options: ['A','B','C','D'] }, { no: 9, text: 'Post Q4', options: ['A','B','C','D'] }, { no: 10, text: 'Post Q5', options: ['A','B','C','D'] },
];

const surveyQuestions = [
    { no: 1, text: 'survey-1', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 2, text: 'survey-2', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 3, text: 'survey-3', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 4, text: 'survey-4', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 5, text: 'survey-5', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 6, text: 'survey-6', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 7, text: 'survey-7', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 8, text: 'survey-8', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 9, text: 'survey-9', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
    { no: 10, text: 'survey-10', options: ['Strongly Agree', 'Agree', 'Neutral', 'Disagree', 'Strongly Disagree'] },
];

function renderQuiz(containerId, items) {
  const box = document.getElementById(containerId);
  box.innerHTML = '';
  for (const q of items) {
  const wrap = document.createElement('div');
  wrap.className = 'quiz-item';
  wrap.innerHTML = `<div><strong>Question ${q.no}.</strong> ${q.text}</div>`;
  const name = `q-${q.no}`;
  q.options.forEach((opt, i) => {
  const id = `${name}-${i}`;
  const row = document.createElement('div');
  row.innerHTML = `
  <label>
  <input type="radio" name="${name}" value="${opt}" id="${id}">
  <span> ${opt}</span>
  </label>`;
  row.querySelector('input').addEventListener('change', (e) => {
  logEvent(`questionNo ${q.no} select`, { answer: opt });
  });
  wrap.appendChild(row);
  });
  box.appendChild(wrap);
}
}

function pauseVideoIfPlaying(reason = 'nav-away') {
	if (!video || video.paused) return;
	logEvent(`video-pause`, { reason }, video.currentTime);
	try { video.pause(); } catch (_) {}
}

let videoStartTime = null;
let hasEverPlayed = false;
let lastVideoTime = 0;
let isSeeking = false;
let watchedIntervals = [];
let currentWatchStart = null;
const JUMP_THRESHOLD = 0.5;

function recordWatchedInterval(newInterval) {
    if (isAltVideo) return;
    let [start, end] = newInterval;
    const MIN_RECORD_DURATION = 1.0;
    if (end - start < MIN_RECORD_DURATION) return;

    let merged = false;
    for (let i = 0; i < watchedIntervals.length; i++) {
        const existing = watchedIntervals[i];
        if (start <= existing[1] + JUMP_THRESHOLD && end >= existing[0] - JUMP_THRESHOLD) {
            existing[0] = Math.min(start, existing[0]);
            existing[1] = Math.max(end, existing[1]);
            merged = true;
            break; 
        }
    }
    if (!merged) watchedIntervals.push(newInterval);
    
    watchedIntervals.sort((a,b) => a[0] - b[0]);
    for (let i = 0; i < watchedIntervals.length - 1; i++) {
        if (watchedIntervals[i][1] >= watchedIntervals[i+1][0] - JUMP_THRESHOLD) {
            watchedIntervals[i][1] = Math.max(watchedIntervals[i][1], watchedIntervals[i+1][1]);
            watchedIntervals.splice(i+1, 1);
            i--;
        }
    }
    updateIntervalsDisplay();
}

function logVideoEvent(eventType, videoPosition = null, extraData = {}) {
	const videoTime = videoPosition !== null ? fmt(videoPosition) : (video ? fmt(video.currentTime) : '0.00');
	logEvent(eventType === 'jump' ? 'video-jump' : `video-${eventType}`, extraData, video ? video.currentTime : 0);
}

function setupVideoLogging() {
  if (!video) return;

  video.addEventListener('play', () => {
    if (isSeeking) return;
    if (!document.fullscreenElement) {
      video.pause();
      alert('Please enter fullscreen to watch the video.');
      return;
    }
    if (!hasEverPlayed) {
      hasEverPlayed = true;
      videoStartTime = Date.now();
    }
    lastVideoTime = video.currentTime;
    if (currentWatchStart === null) currentWatchStart = video.currentTime;
    logVideoEvent('play', video.currentTime);
  });

  video.addEventListener('pause', () => {
    if (isSeeking) return;
    if (hasEverPlayed) {
      if (currentWatchStart !== null) {
          recordWatchedInterval([currentWatchStart, lastVideoTime]);
          currentWatchStart = null;
      }
      logVideoEvent('pause', video.currentTime);
    }
  });

  video.addEventListener('seeking', () => {
    isSeeking = true; 
    if (currentWatchStart !== null) {
        recordWatchedInterval([currentWatchStart, lastVideoTime]);
        currentWatchStart = null;
    }
  });

  video.addEventListener('seeked', () => {
    const from = lastVideoTime;
    const to = video.currentTime;

    if (Math.abs(to - from) >= JUMP_THRESHOLD) {
      logVideoEvent('jump', null, { from, to });
      
      // --- MODIFIED ---
      // Added a check for "!isReturningFromAlt" to prevent the prompt from
      // showing on the programmatic seek when returning from an alt video.
      if (!isAltVideo && treatmentGroup === 1 && !isReturningFromAlt) {
        const part = getCurrentPart();
        if (part) {
          for (const [watchedStart, watchedEnd] of watchedIntervals) {
            if (to >= watchedStart && to <= watchedEnd) {
              logEvent("replay-jump-detected", { part: part.partNumber, jumpTo: to });
              promptAlternativeVideo(to, part);
              break;
            }
          }
        }
      }
    }
    isSeeking = false;
    lastVideoTime = to;
    currentWatchStart = to;
    
    // --- MODIFIED ---
    // Reset the flag after the seek is complete, so the next user-initiated seek is checked.
    if (isReturningFromAlt) {
        isReturningFromAlt = false;
    }
  });
  
  video.addEventListener('timeupdate', () => {
    if (isSeeking || video.paused) return;
    lastVideoTime = video.currentTime;
  });

  video.addEventListener('ended', () => {
    if (currentWatchStart !== null) {
        recordWatchedInterval([currentWatchStart, video.duration]);
        currentWatchStart = null;
    }
    logVideoEvent('ended', video.currentTime);
  });

  video.addEventListener('loadedmetadata', () => {
    logEvent('video-loaded', { duration: video.duration, src: video.currentSrc }, 0);
  });

  video.addEventListener('volumechange', () => { if (hasEverPlayed) logVideoEvent('volume'); });
  video.addEventListener('ratechange', () => { if (hasEverPlayed) logVideoEvent('speed'); });
  video.addEventListener('error', (e) => {
    logEvent('video-error', { error: video.error?.code || 'unknown', message: video.error?.message || 'unknown error' }, video.currentTime);
  });
}

document.addEventListener('fullscreenchange', () => {
  const isFullscreen = !!document.fullscreenElement;
  if (!isFullscreen) {
    if (isExitingForPrompt) {
      isExitingForPrompt = false;
      return; 
    }
    if (currentScreenId !== 'screen-intro' && currentScreenId !== 'screen-done') {
      logEvent('fullscreen-forced-exit');
      pauseVideoIfPlaying('fullscreen-exit');
      logEvent('post-quiz-complete', { forced: true });
      show('screen-done');
      enterPage('finish');
      clearTimeout(batchTimer);
      sendBatch();
    }
  }
});

function enterPage(name) {
page = name;
logEvent('enter-page', { at: ts() });
}

document.getElementById('fullscreen-btn').addEventListener('click', async () => {
  try {
    await document.documentElement.requestFullscreen();
    show('screen-id');
    enterPage('check-andrew-id');
  } catch (err) {
    alert("Please allow fullscreen mode to continue.");
  }
});

document.getElementById('back-1').addEventListener('click', () => {
  show('screen-intro');
  enterPage('intro');
});

document.getElementById('to-pre').addEventListener('click', async () => {
  const val = document.getElementById('participant-id').value.trim();
  if (!val) { alert('Please type your Andrew ID'); return; }
  participantId = val;
  show('screen-verifying');
  enterPage('verifying');

  const bar = document.getElementById('verify-progress');
  bar.style.width = "0%";
  let progress = 0;
  const interval = setInterval(() => {
    if (progress < 90) {
      progress += 5;
      bar.style.width = progress + "%";
    }
  }, 200);

  try {
    const resp = await fetch(LOGGER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify([{ participantId: val, checkOnly: true }])
    });
    const result = await resp.json();
    clearInterval(interval);
    bar.style.width = "100%";
    setTimeout(() => {
      if (result.blocked) {
        show('screen-blocked');
        enterPage('blocked');
      } else {
        treatmentGroup = parseInt(result.treatment, 10);
        console.log(`Participant assigned to treatment group: ${treatmentGroup}`);
        show('screen-pre');
        enterPage('pre-test');
      }
    }, 500);
  } catch (err) {
    clearInterval(interval);
    console.error("Status check failed:", err);
    alert("Could not verify your ID, please try again.");
    show('screen-id');
    enterPage('check-andrew-id');
  }
});

document.getElementById('to-video').addEventListener('click', () => {
  document.querySelectorAll('.quiz-item').forEach(el => { el.style.boxShadow = ''; });
  const warnBox = document.getElementById('quiz-warning');
  if (warnBox) warnBox.remove();

  const unanswered = validateQuizAnswers('pre-quiz', preQuestions);
  if (unanswered.length > 0) {
    showValidationError(unanswered);
    logEvent('pre-quiz-incomplete', { unansweredQuestions: unanswered });
    return;
  }
  logEvent('pre-quiz-complete');
  show('screen-video-1');
  enterPage('video-1');
  setupVideoLogging();
});

document.getElementById('to-video-2').addEventListener('click', () => { show('screen-video-2'); enterPage('video-2'); });
document.getElementById('to-video-3').addEventListener('click', () => { show('screen-video-3'); enterPage('video-3'); });
document.getElementById('to-video-4').addEventListener('click', () => { show('screen-video-4'); enterPage('video-4'); });

document.getElementById('to-post').addEventListener('click', () => {
  if (video && hasEverPlayed) logVideoEvent('stop', video.currentTime);
  show('screen-post');
  enterPage('post-quiz');
});

document.getElementById('to-survey').addEventListener('click', () => {
    const unanswered = validateQuizAnswers('post-quiz', postQuestions);
    if (unanswered.length > 0) {
        showValidationError(unanswered);
        logEvent('post-quiz-incomplete', { unansweredQuestions: unanswered });
        return;
    }
    logEvent('post-quiz-complete');
    show('screen-survey');
    enterPage('survey');
});

document.getElementById('to-finish').addEventListener('click', () => {
    const unanswered = validateQuizAnswers('survey-quiz', surveyQuestions);
    if (unanswered.length > 0) {
        showValidationError(unanswered);
        logEvent('survey-incomplete', { unansweredQuestions: unanswered });
        return;
    }
    logEvent('survey-complete');
    show('screen-done');
    enterPage('finish');
    clearTimeout(batchTimer);
    sendBatch();
});

function validateQuizAnswers(containerId, items) {
const missing = [];
for (const q of items) {
const picked = document.querySelector(`input[name="q-${q.no}"]:checked`);
if (!picked) missing.push(q.no);
}
return missing;
}

function showValidationError(unanswered) {
  document.querySelectorAll('.quiz-item').forEach(el => { el.style.boxShadow = ''; });
  unanswered.forEach(no => {
    const wrap = document.querySelector(`input[name="q-${no}"]`)?.closest('.quiz-item');
    if (wrap) wrap.style.boxShadow = 'inset 0 0 0 2px #ef4444';
  });
  document.querySelector(`input[name="q-${unanswered[0]}"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });

  let warnBox = document.getElementById('quiz-warning');
  if (!warnBox) {
    warnBox = document.createElement('div');
    warnBox.id = 'quiz-warning';
    Object.assign(warnBox.style, {color:'#b91c1c', fontWeight:'600', marginTop:'12px'});
    document.getElementById(currentScreenId).appendChild(warnBox);
  }
  warnBox.textContent = `⚠️ Please answer question(s): ${unanswered.join(', ')}`;
}

function promptAlternativeVideo(returnTime, part) {
    showPromptUI(returnTime, part);
}

function showPromptUI(returnTime, part) {
  if (document.getElementById('alt-video-prompt-container')) return;

  const container = document.getElementById(`prompt-container-${part.partNumber}`);
  if (!container) return;

  const box = document.createElement('div');
  box.id = 'alt-video-prompt-container';
  box.innerHTML = `<p>You replayed a part of the video. Would you like to watch an alternative explanation for this section?</p>
                   <div class="btnrow" style="margin-top:0; justify-content:flex-end;">
                     <button class="secondary" id="alt-no">No, continue</button>
                     <button id="alt-yes">Yes, show alternative</button>
                   </div>`;
  container.appendChild(box);

  document.getElementById('alt-yes').onclick = () => {
    logEvent('alt-video-start', { part: part.partNumber });
    pauseVideoIfPlaying('alt-video-accepted');
    box.remove();
    showAlternativeVideo(returnTime, part);
  };
  document.getElementById('alt-no').onclick = () => {
    logEvent('alt-video-decline', { part: part.partNumber });
    box.remove();
  };
}

function showAlternativeVideo(returnTime, part) {
    isAltVideo = true;
    const currentScreen = document.getElementById(`screen-video-${part.partNumber}`);
    const videoTitle = currentScreen.querySelector('h2');
    
    const rows = currentScreen.querySelectorAll('.btnrow');
    const originalBtnRow = rows[rows.length - 1];
    
    const originalTitle = videoTitle.textContent;

    originalBtnRow.style.display = 'none';
    const newBtnRow = document.createElement('div');
    newBtnRow.className = 'btnrow';
    originalBtnRow.after(newBtnRow);

    videoTitle.textContent = `Alternative Video for Part ${part.partNumber} - ${part.topic}`;

    const backButton = document.createElement('button');
    backButton.className = 'secondary';
    backButton.textContent = '← Back to Main Video';
    newBtnRow.appendChild(backButton);

    const continueButton = document.createElement('button');
    const nextPartNumber = part.partNumber + 1;
    continueButton.textContent = (nextPartNumber <= parts.length)
        ? `→ Continue to Part ${nextPartNumber}`
        : '→ Continue to post-quiz';
    newBtnRow.appendChild(continueButton);

    function restoreOriginalUI() {
        isAltVideo = false;
        videoTitle.textContent = originalTitle;
        newBtnRow.remove();
        originalBtnRow.style.display = 'flex';
    }

    backButton.onclick = () => {
        logEvent('alt-video-return', { part: part.partNumber, returnTime: returnTime });
        restoreOriginalUI();
        
        // --- MODIFIED ---
        // Set the flag to true before changing the video source.
        isReturningFromAlt = true;
        
        video.src = part.mainSrc;
        video.load();
        video.addEventListener('loadedmetadata', () => {
            video.currentTime = returnTime;
            video.play();
        }, { once: true });
    };

    continueButton.onclick = () => {
        pauseVideoIfPlaying('nav-away-from-alt');
        restoreOriginalUI();
        
        if (nextPartNumber <= parts.length) {
            show(`screen-video-${nextPartNumber}`);
            enterPage(`video-${nextPartNumber}`);
        } else {
            show('screen-post');
            enterPage('post-quiz');
        }
    };

    video.src = part.altSrc;
    video.load();
    video.play();
    video.onended = () => { 
        logEvent('alt-video-ended', { part: part.partNumber });
    };
}

function updateIntervalsDisplay() {
  const displayEl = document.getElementById('intervals-display');
  if (!displayEl) return;
  if (watchedIntervals.length === 0) {
    displayEl.textContent = '[No intervals recorded yet]';
  } else {
    const sortedIntervals = watchedIntervals.sort((a, b) => a[0] - b[0]);
    const formattedText = sortedIntervals.map(interval => `[${fmt(interval[0])} - ${fmt(interval[1])}]`).join(' ');
    displayEl.textContent = formattedText;
  }
}

/*** === INIT === ***/
const videoElement = document.getElementById('lecture');
videoElement.addEventListener('click', () => {
  // Check if the video is currently paused or has ended
  if (videoElement.paused || videoElement.ended) {
    // If it is, play the video
    videoElement.play();
  } else {
    // If it's already playing, pause the video
    videoElement.pause();
  }
});

renderQuiz('pre-quiz', preQuestions);
renderQuiz('post-quiz', postQuestions);
renderQuiz('survey-quiz', surveyQuestions);
enterPage('intro');

</script>
</body>
</html>